
{% extends "base.html" %}
{% block extrahead %}
<script src="/static/charts/javascripts/ext-2.3/adapter/ext/ext-base.js" type="text/javascript"></script>
<script src="/static/charts/javascripts/ext-2.3/ext-all.js" type="text/javascript"></script>
<script src="/static/charts/javascripts/OpenLayers-2.8/OpenLayers.js" type="application/javascript"></script>
<script src="/static/charts/javascripts/GeoExt/script/GeoExt.js" type="application/javascript"></script>
<script src="/static/charts/javascripts/jquery-1.3.2.min.js" type="application/javascript"></script>
<script src="/static/charts/javascripts/json2.js" type="application/javascript"></script>

<link rel="stylesheet" type="text/css" href="/static/charts/javascripts/GeoExt/resources/css/geoext-all.css"></link>
<link rel="stylesheet" type="text/css" href="/static/charts/stylesheets/base.css" />

<script type="application/javascript">
$(document).ready(function(){
	var chart_of_country = "http://chart.apis.google.com/chart?cht=p3&chd=t:{{ percentage }}&chs=280x100&chl={{ labels }}"
	var map = new OpenLayers.Map();
	map.maxExtent = new OpenLayers.Bounds(33.37646484375,24.7412109375,59.74365234375,40.6494140625)
    var layer = new OpenLayers.Layer.WMS(
        "Global Imagery",
        "http://labs.metacarta.com/wms/vmap0",
        {layers: "basic"}
    );
    map.addLayer(layer);
    
    var iraq = new OpenLayers.Layer.WMS(
        "Iraq",
        "http://"+window.location.host+"/geoserver/wms",
        {layers: 'GADM:IRQ_adm2', transparent: true, format: 'image/png'},
        {isBaseLayer: false, visibility: true}
    );
    iraq.setOpacity(0.5);
    map.addLayer(iraq);

    new GeoExt.MapPanel({
        renderTo: 'map',
        height: 400,
        width: 600,
        map: map,
        title: 'Click on the map to see the Response chart to see the response chart of the governorate in the area'
    });
	
	map.events.register('click', map, mapEvent);
	function mapEvent(e){
		bounds = map.getExtent().toArray();
        $.get('/get_stat/', {
            left: bounds[0],
            bottom: bounds[1],
            right: bounds[2],
            top: bounds[3],
			x: e.xy.x,
			y: e.xy.y,
			width: map.size.w,
			height: map.size.h
        }, function(response){
			data = JSON.parse(response);
			if(data.has_stats == "true"){
				url = "http://chart.apis.google.com/chart?cht=p3&chd=t:" + data.percentage + "&chs=280x100&chl=" + data.label;
				$("#chart").attr("src", url);
				$("#placename").html(data.place_name);
			}else{
				$("#chart").attr("src", chart_of_country);
				$("#placename").html(data.place_name);
			}
        });
	}
	
});
</script>
{% endblock %}
{% block content %}
<div id="stats">
<span style="float:left;" id="placename">Iraq</span>
<img id="chart" src="http://chart.apis.google.com/chart?cht=p3&chd=t:{{ percentage }}&chs=300x100&chl={{ labels }}"></img>
</div>
<div id="map">
</div>
{% endblock %}

